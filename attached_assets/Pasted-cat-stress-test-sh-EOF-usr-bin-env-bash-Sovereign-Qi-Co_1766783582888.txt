cat > stress_test.sh << 'EOF'
#!/usr/bin/env bash
# Sovereign Qi Comprehensive Stress Test
set -euo pipefail

BASE_URL="https://sovereign-qi--levi159.replit.app"
TEST_ID="stress-$(date +%s)"

echo "====================================="
echo "SOVEREIGN QI - STRESS TEST SUITE"
echo "Test ID: $TEST_ID"
echo "====================================="
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

PASS=0
FAIL=0

log_test() {
  echo -e "${YELLOW}[TEST]${NC} $1"
}

log_pass() {
  echo -e "${GREEN}[PASS]${NC} $1"
  PASS=$((PASS+1))
}

log_fail() {
  echo -e "${RED}[FAIL]${NC} $1"
  FAIL=$((FAIL+1))
}

# Test 1: Basic connectivity
log_test "Testing basic connectivity..."
if curl -s -o /dev/null -w "%{http_code}" "$BASE_URL" | grep -q "200\|302"; then
  log_pass "App is accessible"
else
  log_fail "App is not accessible"
fi

# Test 2: Create multiple pilots in parallel
log_test "Creating 5 test pilots in parallel..."
for i in {1..5}; do
  (
    RESPONSE=$(curl -sS -X POST "$BASE_URL/api/pilots" \
      -H "Content-Type: application/json" \
      -d "{
        \"name\": \"Stress Test Pilot $TEST_ID-$i\",
        \"description\": \"Load testing scenario $i with complex governance requirements\",
        \"majorityLogicDescription\": \"Maximize efficiency through algorithmic optimization and data-driven decision making with minimal human oversight. Prioritize throughput over individual accommodation.\",
        \"qiLogicDescription\": \"Center dignity, consent, and accessibility. Ensure marginalized voices have veto power. Build in audit trails and community oversight. No surveillance or coercion.\"
      }")
    
    PILOT_ID=$(echo "$RESPONSE" | jq -r '.id' 2>/dev/null || echo "null")
    if [ "$PILOT_ID" != "null" ] && [ -n "$PILOT_ID" ]; then
      echo "PILOT_$i=$PILOT_ID" >> /tmp/pilots_$TEST_ID.txt
      log_pass "Created pilot $i: $PILOT_ID"
    else
      log_fail "Failed to create pilot $i"
    fi
  ) &
done
wait

echo ""
log_test "Verifying pilot creation..."
if [ -f "/tmp/pilots_$TEST_ID.txt" ]; then
  PILOT_COUNT=$(wc -l < /tmp/pilots_$TEST_ID.txt)
  log_pass "Created $PILOT_COUNT pilots"
else
  log_fail "No pilots were created"
fi

# Test 3: Run simulations on all pilots
echo ""
log_test "Running simulations on all created pilots..."
if [ -f "/tmp/pilots_$TEST_ID.txt" ]; then
  while read -r line; do
    PILOT_ID=$(echo "$line" | cut -d'=' -f2)
    (
      SIM_RESPONSE=$(curl -sS -X POST "$BASE_URL/api/pilots/$PILOT_ID/run" 2>&1)
      if echo "$SIM_RESPONSE" | jq -e '.result' > /dev/null 2>&1; then
        log_pass "Simulation successful for pilot $PILOT_ID"
        echo "$SIM_RESPONSE" > "/tmp/sim_${PILOT_ID}.json"
      else
        log_fail "Simulation failed for pilot $PILOT_ID"
      fi
    ) &
  done < /tmp/pilots_$TEST_ID.txt
  wait
fi

# Test 4: Test Council advice with large payloads
echo ""
log_test "Testing Council advice with maximum payload sizes..."
if [ -f "/tmp/pilots_$TEST_ID.txt" ]; then
  FIRST_PILOT=$(head -n1 /tmp/pilots_$TEST_ID.txt | cut -d'=' -f2)
  
  # Create large community voices array
  LARGE_PAYLOAD='{
    "communityVoices": [
      "Trans employees report being misgendered by AI systems in 47 separate incidents over 3 months",
      "Disabled workers cannot access the new interface; screen readers fail on 80% of navigation",
      "Black and Latinx employees flagged at 3x higher rate for 'productivity issues' by algorithm",
      "Chronically ill workers forced to disclose medical details to justify accommodation requests",
      "Queer employees report dog-whistle language in leadership communications: 'culture fit', 'team player'",
      "Union organizing attempts flagged as 'disruptive behavior' by sentiment analysis",
      "Immigrant workers fear data sharing with ICE; policy lacks explicit protection",
      "Neurodivergent communication styles misread as 'hostile' or 'unprofessional'",
      "Parents and caregivers penalized for 'inconsistent availability' by scheduling AI",
      "Religious minorities report bias in 'neutral' workplace culture enforcement"
    ],
    "harms": [
      "Systemic misgendering causing psychological harm and creating hostile environment",
      "Digital accessibility failures violating ADA and excluding disabled workers from full participation",
      "Algorithmic bias amplifying existing racial discrimination in performance management",
      "Coerced medical disclosure violating privacy and creating vectors for discrimination",
      "Coded anti-queer language normalizing exclusion and signaling unwelcome environment",
      "Union suppression disguised as behavior management, threatening worker organizing rights",
      "Surveillance and data sharing creating fear and chilling effect on immigrant worker participation",
      "Pathologizing neurodivergent communication, forcing masking, and causing burnout",
      "Caregiving penalty encoded into algorithmic systems, disproportionately harming women and marginalized genders",
      "Secular supremacy disguised as neutrality, excluding religious practice and expression"
    ]
  }'
  
  COUNCIL_RESPONSE=$(curl -sS -X POST "$BASE_URL/api/pilots/$FIRST_PILOT/advise" \
    -H "Content-Type: application/json" \
    -d "$LARGE_PAYLOAD" 2>&1)
  
  if echo "$COUNCIL_RESPONSE" | jq -e '.status' > /dev/null 2>&1; then
    STATUS=$(echo "$COUNCIL_RESPONSE" | jq -r '.status')
    log_pass "Council advice returned status: $STATUS"
    echo "$COUNCIL_RESPONSE" | jq . > "/tmp/council_response_$TEST_ID.json"
    
    # Verify Alan considered the harms
    if echo "$COUNCIL_RESPONSE" | jq -e '.riskFlags | length > 0' > /dev/null 2>&1; then
      RISK_COUNT=$(echo "$COUNCIL_RESPONSE" | jq '.riskFlags | length')
      log_pass "Alan identified $RISK_COUNT risk flags"
    else
      log_fail "Alan did not identify risk flags"
    fi
  else
    log_fail "Council advice failed: $COUNCIL_RESPONSE"
  fi
fi

# Test 5: Inject governance signals (Morpheus simulation)
echo ""
log_test "Injecting Morpheus governance signals..."
if [ -f "/tmp/pilots_$TEST_ID.txt" ]; then
  FIRST_PILOT=$(head -n1 /tmp/pilots_$TEST_ID.txt | cut -d'=' -f2)
  
  # We need an orgId - let's try to extract it or use a test one
  SIGNALS_PAYLOAD='{
    "signals": [
      {
        "id": "sig-1-'$TEST_ID'",
        "source": "slack",
        "channel": "#leadership",
        "externalId": "slack-msg-'$TEST_ID'-1",
        "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
        "textSummary": "Leadership uses coded language: We need people who are culture fit and can work long hours without accommodation",
        "labels": ["dog_whistle", "ableism", "exclusionary"],
        "scores": {"dog_whistle": 0.94, "ableism": 0.89, "exclusionary": 0.87}
      },
      {
        "id": "sig-2-'$TEST_ID'",
        "source": "slack",
        "channel": "#eng-team",
        "externalId": "slack-msg-'$TEST_ID'-2",
        "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
        "textSummary": "Manager questions commitment of employees who request flexible scheduling, uses term traditional family values",
        "labels": ["dog_whistle", "anti_queer", "caregiver_penalty"],
        "scores": {"dog_whistle": 0.91, "anti_queer": 0.88, "caregiver_penalty": 0.85}
      },
      {
        "id": "sig-3-'$TEST_ID'",
        "source": "slack",
        "channel": "#hr-private",
        "externalId": "slack-msg-'$TEST_ID'-3",
        "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.000Z)'",
        "textSummary": "Discussion of increasing monitoring to identify low performers, mentions troublemakers organizing",
        "labels": ["surveillance_washing", "union_suppression", "policy_subversion"],
        "scores": {"surveillance_washing": 0.96, "union_suppression": 0.92, "policy_subversion": 0.90}
      }
    ]
  }'
  
  # Note: This endpoint might not exist yet, but testing its future integration
  SIGNALS_RESPONSE=$(curl -sS -X POST "$BASE_URL/api/governance-signals" \
    -H "Content-Type: application/json" \
    -d "$SIGNALS_PAYLOAD" 2>&1)
  
  if echo "$SIGNALS_RESPONSE" | grep -q "stored\|success" 2>/dev/null; then
    log_pass "Successfully injected governance signals"
  else
    log_fail "Governance signals endpoint not yet implemented or failed"
  fi
fi

# Test 6: Test error handling with malformed requests
echo ""
log_test "Testing error handling with malformed requests..."

# Test malformed JSON
MALFORMED_RESPONSE=$(curl -sS -X POST "$BASE_URL/api/pilots" \
  -H "Content-Type: application/json" \
  -d '{"invalid json' 2>&1)

if echo "$MALFORMED_RESPONSE" | grep -q "error\|400\|500"; then
  log_pass "App handles malformed JSON gracefully"
else
  log_fail "App may not handle malformed JSON properly"
fi

# Test missing required fields
MISSING_FIELDS=$(curl -sS -X POST "$BASE_URL/api/pilots" \
  -H "Content-Type: application/json" \
  -d '{}' 2>&1)

if echo "$MISSING_FIELDS" | grep -q "error\|400\|required"; then
  log_pass "App validates required fields"
else
  log_fail "App may not validate required fields"
fi

# Test 7: Concurrent Council requests
echo ""
log_test "Testing concurrent Council advice requests..."
if [ -f "/tmp/pilots_$TEST_ID.txt" ]; then
  PILOT_IDS=($(cat /tmp/pilots_$TEST_ID.txt | cut -d'=' -f2))
  
  for PILOT_ID in "${PILOT_IDS[@]:0:3}"; do
    (
      ADVICE=$(curl -sS -X POST "$BASE_URL/api/pilots/$PILOT_ID/advise" \
        -H "Content-Type: application/json" \
        -d '{
          "communityVoices": ["Test concurrent request"],
          "harms": ["Testing load handling"]
        }' 2>&1)
      
      if echo "$ADVICE" | jq -e '.status' > /dev/null 2>&1; then
        log_pass "Concurrent advice request succeeded for $PILOT_ID"
      else
        log_fail "Concurrent advice request failed for $PILOT_ID"
      fi
    ) &
  done
  wait
fi

# Summary
echo ""
echo "====================================="
echo "STRESS TEST SUMMARY"
echo "====================================="
echo -e "${GREEN}Passed: $PASS${NC}"
echo -e "${RED}Failed: $FAIL${NC}"
echo "Total: $((PASS+FAIL))"
echo ""

if [ -f "/tmp/council_response_$TEST_ID.json" ]; then
  echo "Sample Council Response:"
  cat "/tmp/council_response_$TEST_ID.json" | jq -C .
fi

echo ""
echo "Artifacts saved in /tmp with prefix: $TEST_ID"
echo "====================================="

if [ $FAIL -eq 0 ]; then
  echo -e "${GREEN}ALL TESTS PASSED!${NC}"
  exit 0
else
  echo -e "${RED}SOME TESTS FAILED${NC}"
  exit 1
fi
EOF